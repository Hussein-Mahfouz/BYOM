---
title: "R Notebook"
author: "Hussein"
output: html_notebook

---
```{r echo = T, results = 'hide'}
library(tidyverse)
library(osmdata)
library(sf)
```



```{r echo = T, results = 'hide'}

# this is a lookup table matching MSOAs to major towns and cities
city_names <- readr::read_csv('Middle_Layer_Super_Output_Area__2011__to_Major_Towns_and_Cities__December_2015__Lookup_in_England_and_Wales.csv') 
# change column name
city_names <- city_names %>% 
  dplyr::rename(city = TCITY15NM)



```
```{r}
city_names
```

```{r echo = T, results = 'hide'}
# flow data from the 2011 census https://www.nomisweb.co.uk/census/2011/bulk/rOD1
flows <- read_csv('flow_data.csv')
```


```{r }
head(flows)
```

# proxy for number of jobs in each MSOA


```{r warning=FALSE}
flows <- flows %>% group_by(`Area of workplace`) %>%
  summarize(jobs = sum(`All categories: Method of travel to work`))

head(flows)
```

```{r}

# add a column with the city name corresponding to each Workplace MSOA
flows <- flows %>% 
  left_join(city_names[,c("MSOA11CD", "city")], by = c("Area of workplace" = "MSOA11CD")) 

head(flows)
```

```{r}
MSOAS <- flows %>% dplyr::filter(city == "Manchester")
```

```{r}

```





```{r}
roads <- opq(bbox = "manchester uk") %>%
  add_osm_feature(key = 'highway')  

```

### To plot the data we can convert it to an sf and then plot the lines

```{r}
library(sf)
roads2 <- osmdata_sf(roads)
plot(st_geometry(roads2$osm_lines))
```
### To use opentriplanner here we want the data in xml format. Ideally we would use pbf data, as it is more compact and makes the analysis faster, but osmdata does not provide the option of saving files in pbf format

```{r}
osmdata_xml(roads, filename = 'manchester.osm')
```

# Part 2: Importing Spatial Data for Analysis


```{r}

```

```{r echo = T, results = 'hide'}

# get geometry of msoas_city. We nned this geometry for plotting later
msoa_geom <- sf::st_read("MSOA_2011_Boundaries/Middle_Layer_Super_Output_Areas__December_2011__Boundaries.shp") %>%
  st_transform(4326)
```
```{r}
# filter only MSOAs in Manchester, using the MSOAS df
msoa_geom <- msoa_geom %>% dplyr::filter(msoa11cd %in% MSOAS$`Area of workplace`)

plot(st_geometry(msoa_geom))
```
```{r echo = T}
centroids <- st_coordinates(st_centroid(msoa_geom))
head(centroids)
```
### let's bind these columns to the msoas df

```{r}
MSOAS <- cbind(MSOAS, centroids)
```

